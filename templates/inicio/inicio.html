<!DOCTYPE html>
{% load static %}
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculo Deserción | UNL</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.10.21/css/dataTables.bootstrap4.min.css">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.datatables.net/1.10.21/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.10.21/js/dataTables.bootstrap4.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.3/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="{% static 'css/inicio.css' %}">
</head>

<body style="background: url('/static/img/LogoBanco.jpg') no-repeat center center fixed; background-size: cover; margin: 0; padding: 0; height: 100vh;">
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="nav-logo">
            <a href="UNL">
                <img src="{% static 'img/SPDE.png' %}" class="logo spde-logo" alt="Logo SPDE">
            </a>
        </div>
        <div class="navbar-collapse collapse show" id="navbarNavDropdown">
            <ul class="navbar-nav ml-auto">
                <li class="nav-item">
                    <a class="nav-link" href="#"><img src="{% static 'assets/user.svg' %}" alt="Usuario"><span>{{ user.username | upper }}</span></a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="{% url 'ayuda' %}"><img src="{% static 'assets/ayuda.svg' %}" alt="Ayuda"><span>Ayuda</span></a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="{% url 'signup' %}"><img src="{% static 'assets/projects.svg' %}" alt="Registrar"><span>Registrar usuario</span></a>
                </li>
                <li class="nav-item">
                    <form method="post" action="{% url 'logout' %}">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-link nav-link"><img src="{% static 'assets/login.svg' %}" alt="Logout"><span>Logout</span></button>
                    </form>
                </li>
            </ul>
        </div>
    </nav>

    <div class="main-container">
        <header class="full-header">
            <div class="content">
                <h1 class="system-title">Sistema de Predicción de Deserción Estudiantil <br><br>
                    <img src="{% static 'img/LogoUNL.png' %}" class="logo unl-logo" alt="Logo UNL">
                </h1>
                <p><br>Con nuestra herramienta obtendrá predicciones sobre la probabilidad de deserción de los estudiantes,
                    lo que le permitirá implementar estrategias para mejorar la retención y el éxito académico.</p>
                <p class="project-info">Proyecto de la Facultad de Ingeniería Automotriz</p>
            </div>
            <div class="carousel-container rounded-carousel">
                <div id="carouselExampleIndicators" class="carousel slide" data-ride="carousel">
                    <div class="carousel-inner">
                        <div class="carousel-item active">
                            <img src="{% static 'img/scroll/LogoAutomotriz.jpg' %}" class="d-block w-100" alt="Slide 1">
                        </div>
                        <div class="carousel-item">
                            <img src="{% static 'img/scroll/LogoSPDErojo.png' %}" class="d-block w-100" alt="Slide 2">
                        </div>
                        <div class="carousel-item">
                            <img src="{% static 'img/scroll/Logorojo.jpg' %}" class="d-block w-100" alt="Slide 2">
                        </div>
                    </div>
                    <a class="carousel-control-prev" href="#carouselExampleIndicators" role="button" data-slide="prev">
                        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                        <span class="sr-only">Previous</span>
                    </a>
                    <a class="carousel-control-next" href="#carouselExampleIndicators" role="button" data-slide="next">
                        <span class="carousel-control-next-icon" aria-hidden="true"></span>
                        <span class="sr-only">Next</span>
                    </a>
                </div>
            </div>
        </header>

        <section class="container2">
            <h2>Predicción de Deserción Estudiantil</h2>
            <form method="post" enctype="multipart/form-data" id="upload-form">
                {% csrf_token %}
                {{ form.as_p }}
                <button class="boton button-generate-chart" type="submit" name="predict">Cargar y Predecir</button>
                {% if file_uploaded %}
                <span id="file-uploaded-message" class="file-uploaded-message">Archivo cargado exitosamente</span>
                {% endif %}
            </form>
            {% if messages %}
            <ul class="messages">
                {% for message in messages %}
                <li{% if message.tags %} class="{{ message.tags }}" {% endif %}>{{ message }}</li>
                    {% endfor %}
            </ul>
            {% endif %}

            {% if file_uploaded %}
            <div class="tab-container">
                {% for ciclo in predictions.keys %}
                <div class="tab" id="tab-btn-{{ ciclo }}" onclick="showTab('{{ ciclo }}')">Ciclo {{ ciclo }}</div>
                {% endfor %}
            </div>
            <section id="prediction-section">
                {% for ciclo, prediction in predictions.items %}
                <div id="tab-{{ ciclo }}" class="tab-content">
                    <div class="section-container">
                        <h2 class="section-header">Resultados de la Predicción - Ciclo {{ ciclo }}</h2>
                        <div class="table-container">
                            {{ prediction|safe }}
                        </div>
                        <button class="boton button-generate-chart" onclick="generateChart('{{ ciclo }}')">Generar
                            Gráfico</button>
                    </div>
                    <div id="chart-container-{{ ciclo }}" class="section-container chart-container">
                        <h2 class="section-header">Gráfico de la Predicción - Ciclo {{ ciclo }}</h2>
                        <canvas id="grafico-{{ ciclo }}"></canvas>
                    </div>
                </div>
                {% endfor %}
            </section>
            {% endif %}

            {% if general_stats %}
            <section class="stats-container">
                <h2>Estadísticas Generales</h2>
                <div class="stats-item">
                    <div class="stats-label">Ciclo con Mayor Deserción:</div>
                    <div class="stats-value">{{ general_stats.ciclo_con_mayor_desercion }}</div>
                </div>
                <div class="stats-item">
                    <div class="stats-label">Ciclo con Menor Deserción:</div>
                    <div class="stats-value">{{ general_stats.ciclo_con_menor_desercion }}</div>
                </div>
                <div class="stats-item">
                    <div class="stats-label">Porcentaje Promedio de Deserción:</div>
                    <div class="stats-value">{{ general_stats.porcentaje_promedio_desercion|floatformat:2 }}%</div>
                </div>
                <div class="stats-item">
                    <div class="stats-label">Número Total de Estudiantes:</div>
                    <div class="stats-value">{{ general_stats.total_estudiantes }}</div>
                </div>
                <div class="stats-item">
                    <div class="stats-label">Número de Estudiantes con Alta Probabilidad de Deserción:</div>
                    <div class="stats-value">{{ general_stats.estudiantes_alta_desercion }}</div>
                </div>
                <div class="stats-item">
                    <div class="stats-label">Número de Estudiantes con Media Probabilidad de Deserción:</div>
                    <div class="stats-value">{{ general_stats.estudiantes_media_desercion }}</div>
                </div>
                <div class="stats-item">
                    <div class="stats-label">Número de Estudiantes con Baja Probabilidad de Deserción:</div>
                    <div class="stats-value">{{ general_stats.estudiantes_baja_desercion }}</div>
                </div>
            </section>
            {% endif %}
        </section>
    </div>

    <script id="data-per-cycle" type="application/json">
        {{ data_per_cycle|safe }}
    </script>

    <script>
        const dataPerCycle = JSON.parse(document.getElementById('data-per-cycle').textContent);

        function showTab(ciclo) {
            var tabs = document.getElementsByClassName('tab-content');
            for (var i = 0; i < tabs.length; i++) {
                tabs[i].classList.remove('active');
            }
            var activeTab = document.getElementById('tab-' + ciclo);
            if (activeTab) {
                activeTab.classList.add('active');
            }
            var tabButtons = document.getElementsByClassName('tab');
            for (var i = 0; i < tabButtons.length; i++) {
                tabButtons[i].classList.remove('active');
            }
            var activeTabButton = document.getElementById('tab-btn-' + ciclo);
            if (activeTabButton) {
                activeTabButton.classList.add('active');
            }
        }

        function generateChart(ciclo) {
            var ctx = document.getElementById('grafico-' + ciclo).getContext('2d');
            var data = {
                labels: dataPerCycle[ciclo].estudiantes, // Usar los datos reales aquí
                datasets: [
                    {
                        label: 'Probabilidad Aproximada de Deserción',
                        data: dataPerCycle[ciclo].probabilidades, // Usar los datos reales aquí
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1
                    },
                    {
                        label: 'Predicción de Deserción',
                        data: dataPerCycle[ciclo].predicciones_futuras,
                        backgroundColor: 'rgba(54, 162, 235, 0.5)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    }
                ]
            };
            var options = {
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            };
            new Chart(ctx, {
                type: 'bar',
                data: data,
                options: options
            });
            document.getElementById('chart-container-' + ciclo).style.display = 'block'; // Mostrar el contenedor del gráfico
        }

        document.addEventListener('DOMContentLoaded', function () {
            var firstTab = document.querySelector('.tab');
            if (firstTab) {
                showTab(firstTab.innerText.split(' ')[1]);
            }
            $('.table-container table').DataTable({
                language: {
                    url: "//cdn.datatables.net/plug-ins/1.11.3/i18n/es_es.json",
                    info: "Mostrando _START_ a _END_ de _TOTAL_ estudiantes",
                    lengthMenu: "Mostrar _MENU_ registros por página",
                    paginate: {
                        first: "Primero",
                        last: "Último",
                        next: "Siguiente",
                        previous: "Anterior"
                    },
                    search: "Buscar:",
                    zeroRecords: "No se encontraron estudiantes coincidentes",
                    infoFiltered: "(Filtrado de _MAX_ estudiante totales)"
                }
            });
        });
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const fileInput = document.querySelector('input[type="file"]');
            const fileUploadedMessage = document.querySelector('#file-uploaded-message');

            if (fileInput && fileUploadedMessage) {
                fileInput.addEventListener('change', function () {
                    if (fileInput.files.length > 0) {
                        fileUploadedMessage.style.display = 'inline-block';
                    } else {
                        fileUploadedMessage.style.display = 'none';
                    }
                });
            }
        });
    </script>
</body>

</html>
